<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gamer Rave Giveaway</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />


  <!-- PapaParse for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">

    <h1 class="text-center mb-4">ðŸŽ® Gamer Rave Giveaway</h1>

    <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
      <button id="loadBtn" class="btn btn-primary">Load Entries</button>
      <button id="pickBtn" class="btn btn-success">Pick a Winner</button>
    </div>

    <h2 id="winner" class="text-center mb-3">No winner yet</h2>

    <!-- Dropdown container, hidden until entries are loaded -->
    <div id="dropdownContainer" class="d-none">
      <label for="entriesDropdown" class="form-label text-center d-block">
        All Valid Entrants
      </label>
      <select id="entriesDropdown" class="form-select mx-auto w-75"></select>
    </div>

  </div>

  <script>
    let validEntries = [];

    async function loadEntries() {
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj0yrXpnSGjteWybJAiv71i2elpcmv9L1iZOGA1XSxkuKNFiQw6QesxMPBULWyZzX3zc4NhGu2fLmn/gviz/tq?tqx=out:csv&gid=2124022789";
      try {
        const resp = await fetch(CSV_URL);
        const text = await resp.text();
        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true
        });

        if (parsed.errors.length) {
          console.error("CSV parse errors:", parsed.errors);
          alert("Spreadsheet parsed with errorsâ€”see console.");
          return;
        }

        validEntries = parsed.data.filter(r =>
          r["Are you a DJ, Vendor or Performer at Gamer Rave?"] !== "Yes"
        );

        alert(`Loaded ${validEntries.length} valid guest entries.`);
        populateDropdown();
      } catch (err) {
        console.error("Fetch failed:", err);
        alert("Failed to load the spreadsheet.");
      }
    }

    function pickWinner() {
      if (validEntries.length === 0) {
        alert("No valid entries loaded. Please click 'Load Entries' first.");
        return;
      }
      const w = validEntries[Math.floor(Math.random() * validEntries.length)];
      const name  = w["Name"]          || "Unnamed";
      const email = w["Email Address"] || "No Email";
      document.getElementById("winner").innerText =
        `ðŸŽ‰ Winner: ${name} (${email})`;
    }

    function populateDropdown() {
      const container = document.getElementById("dropdownContainer");
      const select = document.getElementById("entriesDropdown");

      // clear old options
      select.innerHTML = "";

      // add one <option> per valid entry
      validEntries.forEach((row, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = `${row["Name"]} (${row["Email Address"]})`;
        select.append(opt);
      });

      // show the dropdown
      container.classList.remove("d-none");
      container.classList.add("d-block");
    }

    // wire up buttons
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loadBtn").addEventListener("click", loadEntries);
      document.getElementById("pickBtn").addEventListener("click", pickWinner);
    });
  </script>
</body>
</html>
